name: Finalize Notarization (mac)

on:
  workflow_run:
    workflows: ["Release Desktop (mac + win)"]
    types: [completed]

  workflow_dispatch:
    inputs:
      run_id:
        description: "Release Desktop workflow run id (Actions run id)"
        required: true
        type: string
      tag:
        description: "Release tag (e.g. v1.3.0). Required for upload/publish on manual runs."
        required: true
        type: string

permissions:
  contents: write
  actions: read

jobs:
  finalize:
    if: >
      ${{
        (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
        || github.event_name == 'workflow_dispatch'
      }}
    runs-on: macos-14
    timeout-minutes: 240

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve source run id + tag
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            RUN_ID="${{ github.event.workflow_run.id }}"
            HEAD_SHA="${{ github.event.workflow_run.head_sha }}"
            echo "RUN_ID=$RUN_ID" >> $GITHUB_OUTPUT
            echo "HEAD_SHA=$HEAD_SHA" >> $GITHUB_OUTPUT

            git fetch --tags --force
            TAG="$(git tag --points-at "$HEAD_SHA" | head -n 1 || true)"
            echo "TAG=$TAG" >> $GITHUB_OUTPUT

            echo "Using RUN_ID=$RUN_ID"
            echo "Resolved TAG=${TAG:-<none>}"
          else
            RUN_ID="${{ inputs.run_id }}"
            TAG="${{ inputs.tag }}"
            echo "RUN_ID=$RUN_ID" >> $GITHUB_OUTPUT
            echo "HEAD_SHA=" >> $GITHUB_OUTPUT
            echo "TAG=$TAG" >> $GITHUB_OUTPUT

            echo "Using RUN_ID=$RUN_ID"
            echo "Using TAG=$TAG"
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22.12.0

      - name: Install deps
        working-directory: rezzy-webpanel
        run: npm ci

      - name: Download notarization ids artifact from build run
        uses: actions/download-artifact@v4
        with:
          name: notarization-ids
          run-id: ${{ steps.meta.outputs.RUN_ID }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: /tmp/notary

      - name: Read IDs
        id: ids
        shell: bash
        run: |
          set -euo pipefail
          echo "== notary-ids.txt =="
          cat /tmp/notary/notary-ids.txt

          APP_ZIP_ID="$(grep -E '^APP_ZIP_SUBMISSION_ID=' /tmp/notary/notary-ids.txt | cut -d= -f2 || true)"
          if [ -z "${APP_ZIP_ID:-}" ]; then
            echo "APP_ZIP_SUBMISSION_ID missing in notary-ids.txt"
            exit 1
          fi

          echo "APP_ZIP_ID=$APP_ZIP_ID" >> $GITHUB_OUTPUT

      - name: Download mac dist artifact from build run
        uses: actions/download-artifact@v4
        with:
          name: mac-dist
          run-id: ${{ steps.meta.outputs.RUN_ID }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: /tmp/mac-dist

      - name: Prepare working dist folder
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p rezzy-webpanel/dist

          DMG_SRC="$(find /tmp/mac-dist -type f -name '*.dmg' | head -n 1 || true)"
          APP_ZIP_SRC="$(find /tmp/mac-dist -type f -name '*-app.zip' | head -n 1 || true)"

          if [ -z "${APP_ZIP_SRC:-}" ]; then
            echo "No *-app.zip found inside mac-dist artifact"
            find /tmp/mac-dist -maxdepth 3 -type f | head -n 80 || true
            exit 1
          fi

          cp -f "$APP_ZIP_SRC" rezzy-webpanel/dist/
          if [ -n "${DMG_SRC:-}" ]; then
            cp -f "$DMG_SRC" rezzy-webpanel/dist/
          fi

          echo "Dist contents:"
          ls -la rezzy-webpanel/dist

      - name: Poll until Accepted + Staple .app + Re-zip (logs on reject/invalid)
        shell: bash
        working-directory: rezzy-webpanel
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APP_ZIP_ID: ${{ steps.ids.outputs.APP_ZIP_ID }}
        run: |
          set -euo pipefail

          if ! command -v jq >/dev/null 2>&1; then
            echo "jq is required but not found."
            exit 1
          fi

          xcrun notarytool store-credentials "rezvix-notary" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" || true

          show_info () {
            local id="$1"
            xcrun notarytool info "$id" --keychain-profile "rezvix-notary" --output-format json || true
          }

          show_log () {
            local id="$1"
            echo "========== NOTARY LOG ($id) =========="
            xcrun notarytool log "$id" --keychain-profile "rezvix-notary" || true
            echo "========== END NOTARY LOG ($id) =========="
          }

          poll () {
            local id="$1"
            local label="$2"
            local max_minutes=180
            local sleep_sec=30
            local start_ts now_ts elapsed

            start_ts=$(date +%s)
            echo "Polling $label id=$id (max ${max_minutes}m)"

            while true; do
              now_ts=$(date +%s)
              elapsed=$(( (now_ts - start_ts) / 60 ))

              info="$(xcrun notarytool info "$id" --keychain-profile "rezvix-notary" --output-format json 2>/dev/null || true)"
              status="$(echo "$info" | jq -r '.status // empty')"
              echo "Status ($label): ${status:-<unknown>} (t=${elapsed}m)"

              case "$status" in
                Accepted) return 0 ;;
                Invalid)
                  echo "INVALID ($label). Info:"
                  show_info "$id"
                  echo "INVALID ($label). Fetching log..."
                  show_log "$id"
                  exit 1
                  ;;
                Rejected)
                  echo "REJECTED ($label). Info:"
                  show_info "$id"
                  echo "REJECTED ($label). Fetching log..."
                  show_log "$id"
                  exit 1
                  ;;
              esac

              if [ "$elapsed" -ge "$max_minutes" ]; then
                echo "Still In Progress after ${max_minutes}m. Exiting 0 so you can rerun later."
                show_info "$id"
                exit 0
              fi

              sleep "$sleep_sec"
            done
          }

          APP_ZIP_PATH="$(ls -1 dist/*-app.zip | head -n 1 || true)"
          if [ -z "${APP_ZIP_PATH:-}" ]; then
            echo "app.zip not found in rezzy-webpanel/dist"
            ls -la dist || true
            exit 1
          fi

          poll "$APP_ZIP_ID" "APP_ZIP"

          # Accepted -> unzip -> staple .app -> rezip
          WORK="/tmp/rezvix_staple"
          rm -rf "$WORK"
          mkdir -p "$WORK/unzip" "$WORK/out"

          echo "Unzipping: $APP_ZIP_PATH"
          ditto -x -k "$APP_ZIP_PATH" "$WORK/unzip"

          APP_PATH="$(find "$WORK/unzip" -maxdepth 3 -type d -name '*.app' | head -n 1 || true)"
          if [ -z "${APP_PATH:-}" ]; then
            echo "No .app found inside app.zip after unzip"
            find "$WORK/unzip" -maxdepth 4 -type f | head -n 80 || true
            exit 1
          fi

          echo "Stapling .app => $APP_PATH"
          xcrun stapler staple -v "$APP_PATH"
          xcrun stapler validate -v "$APP_PATH"

          TAG="${{ steps.meta.outputs.TAG }}"
          if [ -z "${TAG:-}" ]; then
            # manual run already provides tag; workflow_run resolves it
            echo "TAG is empty; cannot name output reliably."
            exit 1
          fi

          OUT_ZIP="dist/Rezvix-${TAG#v}-app-notarized.zip"
          echo "Creating notarized app zip => $OUT_ZIP"
          ditto -c -k --keepParent "$APP_PATH" "$OUT_ZIP"

          echo "Final dist:"
          ls -la dist || true

      - name: Upload notarized artifacts to GitHub Release (same tag)
        if: ${{ steps.meta.outputs.TAG != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.TAG }}
          files: |
            rezzy-webpanel/dist/*-app-notarized.zip
            rezzy-webpanel/dist/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish draft release
        if: ${{ steps.meta.outputs.TAG != '' }}
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.meta.outputs.TAG }}
        run: |
          set -euo pipefail
          gh release edit "$TAG" --draft=false
          echo "Release published: $TAG"