name: Release Desktop (mac + win)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22.12.0
          cache: npm
          cache-dependency-path: rezzy-webpanel/package-lock.json

      - name: Install
        working-directory: rezzy-webpanel
        run: npm ci

      - name: Import Apple Developer ID Certificate
        if: runner.os == 'macOS'
        env:
          MAC_CERTS_B64: ${{ secrets.MAC_CERTS_B64 }}
          MAC_CERTS_PASSWORD: ${{ secrets.MAC_CERTS_PASSWORD }}
        run: |
          set -euo pipefail

          if [ -z "${MAC_CERTS_B64:-}" ]; then
            echo "MAC_CERTS_B64 is empty. Secrets are not available to this run."
            exit 1
          fi

          echo "$MAC_CERTS_B64" | base64 --decode > /tmp/mac-certs.p12

          if [ ! -s /tmp/mac-certs.p12 ]; then
            echo "/tmp/mac-certs.p12 is empty after base64 decode."
            exit 1
          fi

          security create-keychain -p "" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "" build.keychain

          # search list + default (kritik)
          security list-keychains -d user -s build.keychain
          security default-keychain -s build.keychain

          # import (CI için stabil)
          security import /tmp/mac-certs.p12 -k build.keychain -P "$MAC_CERTS_PASSWORD" -A

          # codesign erişimi
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain

          security find-identity -v -p codesigning build.keychain
          security show-keychain-info build.keychain || true

      - name: Network check (Apple)
        if: runner.os == 'macOS'
        run: |
          echo "Checking Apple connectivity..."
          curl -I --max-time 20 https://appstoreconnect.apple.com || true
          curl -I --max-time 20 https://appstoreconnect.apple.com/notary/v2/ || true
          curl -I --max-time 20 https://developer.apple.com || true

      - name: Codesign sanity check (mac)
        if: runner.os == 'macOS'
        run: |
          set -e
          security list-keychains -d user
          security find-identity -v -p codesigning
          echo "test" > /tmp/codesign-test.txt
          codesign -s "Developer ID Application" --timestamp /tmp/codesign-test.txt || true

      - name: Build + Publish to GitHub Releases
        working-directory: rezzy-webpanel
        run: npx electron-builder --publish always
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CI: true

          DEBUG: "electron-builder,electron-builder:*,app-builder-lib:*"
          ELECTRON_BUILDER_LOG_LEVEL: debug
          CSC_DEBUG: "true"

          # codesign
          CSC_IDENTITY_AUTO_DISCOVERY: ${{ runner.os == 'macOS' && 'true' || '' }}
          CSC_KEYCHAIN: build.keychain
          CSC_KEYCHAIN_PASSWORD: ""

          # notarize (afterSign -> electron/notarize.cjs)
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          NOTARY_RETRIES: "6"