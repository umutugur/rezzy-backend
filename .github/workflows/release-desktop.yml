name: Release Desktop (mac + win)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: rezzy-webpanel/package-lock.json

      # ✅ electron-builder cache (çok hızlandırır)
      - name: Cache electron-builder
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
            ~/Library/Caches/electron
            ~/Library/Caches/electron-builder
          key: ${{ runner.os }}-electron-builder-${{ hashFiles('rezzy-webpanel/package-lock.json') }}

      - name: Install
        working-directory: rezzy-webpanel
        run: npm ci

      - name: Import Apple Developer ID Certificate
        if: runner.os == 'macOS'
        env:
          MAC_CERTS_B64: ${{ secrets.MAC_CERTS_B64 }}
          MAC_CERTS_PASSWORD: ${{ secrets.MAC_CERTS_PASSWORD }}
        run: |
          echo "$MAC_CERTS_B64" | base64 --decode > /tmp/mac-certs.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import /tmp/mac-certs.p12 -k build.keychain -P "$MAC_CERTS_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          security find-identity -v -p codesigning

      - name: Network check (Apple)
        if: runner.os == 'macOS'
        run: |
          echo "Checking Apple connectivity..."
          curl -I --max-time 20 https://appstoreconnect.apple.com || true
          curl -I --max-time 20 https://developer.apple.com || true

      - name: Build + Publish to GitHub Releases
        working-directory: rezzy-webpanel
        run: npx electron-builder --publish always --verbose
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CI: true

          # log
          DEBUG: "electron-builder,electron-builder:*,app-builder-lib:*,@electron/notarize*"
          ELECTRON_BUILDER_LOG_LEVEL: debug

          # mac only notarize (electron-builder built-in)
          CSC_IDENTITY_AUTO_DISCOVERY: ${{ runner.os == 'macOS' && 'true' || '' }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}