name: Finalize Notarization (mac)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag name (e.g. v1.2.4)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  finalize:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22.12.0

      - name: Install deps
        working-directory: rezzy-webpanel
        run: npm ci

      - name: Download notarization ids artifact
        uses: actions/download-artifact@v4
        with:
          name: notarization-ids
          path: /tmp/notary

      - name: Read IDs
        id: ids
        shell: bash
        run: |
          set -euo pipefail
          cat /tmp/notary/notary-ids.txt
          echo "DMG_ID=$(grep -E '^DMG_SUBMISSION_ID=' /tmp/notary/notary-ids.txt | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "ZIP_ID=$(grep -E '^ZIP_SUBMISSION_ID=' /tmp/notary/notary-ids.txt | cut -d= -f2 || true)" >> $GITHUB_OUTPUT

      - name: Import Apple Developer ID Certificate
        shell: bash
        env:
          MAC_CERTS_B64: ${{ secrets.MAC_CERTS_B64 }}
          MAC_CERTS_PASSWORD: ${{ secrets.MAC_CERTS_PASSWORD }}
        run: |
          set -euo pipefail
          echo "$MAC_CERTS_B64" | base64 --decode > /tmp/mac-certs.p12
          security create-keychain -p "" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "" build.keychain
          security list-keychains -d user -s build.keychain
          security default-keychain -s build.keychain
          security import /tmp/mac-certs.p12 -k build.keychain -P "$MAC_CERTS_PASSWORD" -A
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain

      - name: Build again (mac) to get same DMG/ZIP
        shell: bash
        working-directory: rezzy-webpanel
        env:
          CI: true
          CSC_IDENTITY_AUTO_DISCOVERY: "true"
          CSC_KEYCHAIN: build.keychain
          CSC_KEYCHAIN_PASSWORD: ""
        run: |
          set -euo pipefail
          npx electron-builder --mac dmg zip --publish never

      - name: Poll until Accepted + Staple
        shell: bash
        working-directory: rezzy-webpanel
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          DMG_ID: ${{ steps.ids.outputs.DMG_ID }}
          ZIP_ID: ${{ steps.ids.outputs.ZIP_ID }}
        run: |
          set -euo pipefail
          if ! command -v jq >/dev/null 2>&1; then
            echo "jq is required but not found."
            exit 1
          fi

          xcrun notarytool store-credentials "rezvix-notary" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" || true

          poll () {
            local id="$1"
            local label="$2"
            local max_minutes=30
            local sleep_sec=20
            local start_ts now_ts elapsed

            start_ts=$(date +%s)
            echo "Polling $label id=$id"

            while true; do
              now_ts=$(date +%s)
              elapsed=$(( (now_ts - start_ts) / 60 ))
              if [ "$elapsed" -ge "$max_minutes" ]; then
                echo "Still not Accepted after ${max_minutes}m. Stop here and rerun later."
                xcrun notarytool info "$id" --keychain-profile "rezvix-notary" --output-format json || true
                exit 1
              fi

              info="$(xcrun notarytool info "$id" --keychain-profile "rezvix-notary" --output-format json 2>/dev/null || true)"
              status="$(echo "$info" | jq -r '.status // empty')"
              echo "Status ($label): ${status:-<unknown>} (t=${elapsed}m)"

              case "$status" in
                Accepted) return 0 ;;
                Invalid)
                  echo "INVALID ($label). Log:"
                  xcrun notarytool log "$id" --keychain-profile "rezvix-notary" || true
                  exit 1
                  ;;
                *) sleep "$sleep_sec" ;;
              esac
            done
          }

          DMG_PATH="$(ls -1 dist/*.dmg | head -n 1)"
          ZIP_PATH="$(ls -1 dist/*-mac.zip | head -n 1 || true)"

          poll "$DMG_ID" "DMG"
          echo "Stapling DMG..."
          xcrun stapler staple -v "$DMG_PATH"
          xcrun stapler validate -v "$DMG_PATH"

          if [ -n "${ZIP_ID:-}" ] && [ -n "${ZIP_PATH:-}" ]; then
            poll "$ZIP_ID" "ZIP"
          fi

      - name: Upload notarized mac artifacts to GitHub Release (still draft)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          draft: true
          files: |
            rezzy-webpanel/dist/*.dmg
            rezzy-webpanel/dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}