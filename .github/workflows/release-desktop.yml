name: Release Desktop (mac + win)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22.12.0
          cache: npm
          cache-dependency-path: rezzy-webpanel/package-lock.json

      - name: Install
        working-directory: rezzy-webpanel
        run: npm ci

      # -------------------- macOS: cert import + keychain --------------------
      - name: Import Apple Developer ID Certificate (mac)
        if: runner.os == 'macOS'
        shell: bash
        env:
          MAC_CERTS_B64: ${{ secrets.MAC_CERTS_B64 }}
          MAC_CERTS_PASSWORD: ${{ secrets.MAC_CERTS_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -z "${MAC_CERTS_B64:-}" ] || [ -z "${MAC_CERTS_PASSWORD:-}" ]; then
            echo "Missing MAC cert secrets."
            exit 1
          fi

          echo "$MAC_CERTS_B64" | base64 --decode > /tmp/mac-certs.p12

          security create-keychain -p "" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "" build.keychain

          security list-keychains -d user -s build.keychain
          security default-keychain -s build.keychain

          security import /tmp/mac-certs.p12 -k build.keychain -P "$MAC_CERTS_PASSWORD" -A
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain

          security find-identity -v -p codesigning build.keychain

      # -------------------- Windows: build + publish --------------------
      - name: Build + Publish (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        working-directory: rezzy-webpanel
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CI: true
        run: |
          npx electron-builder --win --x64 --publish always

      # -------------------- macOS: build DMG + produce custom app.zip --------------------
      - name: Build (macOS) - dmg + app.zip (NO notarize for dmg)
        if: runner.os == 'macOS'
        shell: bash
        working-directory: rezzy-webpanel
        env:
          CI: true
          CSC_IDENTITY_AUTO_DISCOVERY: "true"
          CSC_KEYCHAIN: build.keychain
          CSC_KEYCHAIN_PASSWORD: ""
        run: |
          set -euo pipefail

          # DMG üret (sadece dağıtım taşıyıcısı)
          npx electron-builder --mac dmg --publish never

          # .app bulun
          APP_PATH="$(find dist -maxdepth 3 -type d -name '*.app' | head -n 1 || true)"
          if [ -z "${APP_PATH:-}" ]; then
            echo "No .app found under rezzy-webpanel/dist"
            find dist -maxdepth 4 -type f | head -n 80 || true
            exit 1
          fi

          VERSION="$(node -p "require('./package.json').version")"
          APP_ZIP="dist/Rezvix-${VERSION}-app.zip"

          echo "APP_PATH=$APP_PATH"
          echo "Creating app.zip => $APP_ZIP"

          # Apple’ın sevdiği zip formatı (ditto)
          ditto -c -k --keepParent "$APP_PATH" "$APP_ZIP"

          echo "Dist contents:"
          ls -la dist || true

      # -------------------- macOS: submit notarization ONLY for app.zip --------------------
      - name: Submit Notarization (macOS) - app.zip (non-blocking)
        if: runner.os == 'macOS'
        shell: bash
        working-directory: rezzy-webpanel
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -euo pipefail

          if [ -z "${APPLE_ID:-}" ] || [ -z "${APPLE_APP_SPECIFIC_PASSWORD:-}" ] || [ -z "${APPLE_TEAM_ID:-}" ]; then
            echo "Missing APPLE notarization secrets."
            exit 1
          fi

          if ! command -v jq >/dev/null 2>&1; then
            echo "jq is required but not found on runner."
            exit 1
          fi

          APP_ZIP_PATH="$(ls -1 dist/*-app.zip | head -n 1 || true)"
          if [ -z "${APP_ZIP_PATH:-}" ]; then
            echo "app.zip not found under rezzy-webpanel/dist"
            ls -la dist || true
            exit 1
          fi

          echo "APP_ZIP: $APP_ZIP_PATH"

          xcrun notarytool store-credentials "rezvix-notary" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" || true

          out="$(xcrun notarytool submit "$APP_ZIP_PATH" --keychain-profile "rezvix-notary" --output-format json)"
          APP_ZIP_ID="$(echo "$out" | jq -r '.id')"

          echo "APP_ZIP_SUBMISSION_ID=$APP_ZIP_ID" | tee dist/notary-ids.txt

          echo "== notary-ids.txt =="
          cat dist/notary-ids.txt
          echo "Do NOT wait here."

      # -------------------- macOS: upload artifacts (needed by finalize) --------------------
      - name: Upload mac dist artifact (mac)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: mac-dist
          path: |
            rezzy-webpanel/dist/*.dmg
            rezzy-webpanel/dist/*-app.zip
          if-no-files-found: error

      - name: Upload notarization ids artifact (mac)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: notarization-ids
          path: rezzy-webpanel/dist/notary-ids.txt
          if-no-files-found: error

      # -------------------- macOS: upload to GitHub Release (draft) --------------------
      - name: Upload mac artifacts to GitHub Release (draft)
        if: runner.os == 'macOS' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: |
            rezzy-webpanel/dist/*.dmg
            rezzy-webpanel/dist/*-app.zip
            rezzy-webpanel/dist/notary-ids.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}