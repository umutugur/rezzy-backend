name: Release Desktop (mac + win)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22.12.0
          cache: npm
          cache-dependency-path: rezzy-webpanel/package-lock.json

      - name: Install
        working-directory: rezzy-webpanel
        run: npm ci

      # -------------------- mac: cert import --------------------
      - name: Import Apple Developer ID Certificate
        if: runner.os == 'macOS'
        env:
          MAC_CERTS_B64: ${{ secrets.MAC_CERTS_B64 }}
          MAC_CERTS_PASSWORD: ${{ secrets.MAC_CERTS_PASSWORD }}
        run: |
          set -euo pipefail

          if [ -z "${MAC_CERTS_B64:-}" ]; then
            echo "MAC_CERTS_B64 is empty."
            exit 1
          fi

          echo "$MAC_CERTS_B64" | base64 --decode > /tmp/mac-certs.p12
          if [ ! -s /tmp/mac-certs.p12 ]; then
            echo "/tmp/mac-certs.p12 is empty after decode."
            exit 1
          fi

          security create-keychain -p "" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "" build.keychain

          security list-keychains -d user -s build.keychain
          security default-keychain -s build.keychain

          # Import (CI’da en stabil)
          security import /tmp/mac-certs.p12 -k build.keychain -P "$MAC_CERTS_PASSWORD" -A

          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain

          security find-identity -v -p codesigning build.keychain
        shell: bash

      # -------------------- build --------------------
      - name: Build (win publish, mac build only)
        working-directory: rezzy-webpanel
        run: |
          set -e
          if [ "$RUNNER_OS" = "Windows" ]; then
            npx electron-builder --publish always
          else
            # mac: önce sadece build al (publish yok) -> notarize/staple sonrası release’e yükleyeceğiz
            npx electron-builder --mac dmg zip --publish never
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CI: true
          CSC_IDENTITY_AUTO_DISCOVERY: ${{ runner.os == 'macOS' && 'true' || '' }}
          CSC_KEYCHAIN: build.keychain
          CSC_KEYCHAIN_PASSWORD: ""

      # -------------------- mac: notarize + staple --------------------
      - name: Notarize DMG & ZIP (mac)
        if: runner.os == 'macOS'
        working-directory: rezzy-webpanel
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -euo pipefail

          ls -la dist || true

          # dist içinde dmg/zip adlarını yakala
          DMG_PATH="$(ls -1 dist/*.dmg | head -n 1)"
          ZIP_PATH="$(ls -1 dist/*.zip | head -n 1)"

          echo "DMG: $DMG_PATH"
          echo "ZIP: $ZIP_PATH"

          # notarytool credentials profile
          xcrun notarytool store-credentials "rezvix-notary" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD"

          # ✅ Notarize DMG (wait)
          xcrun notarytool submit "$DMG_PATH" --keychain-profile "rezvix-notary" --wait

          # ✅ Staple DMG
          xcrun stapler staple -v "$DMG_PATH"
          xcrun stapler validate -v "$DMG_PATH"

          # (Opsiyonel ama tavsiye: zip’i de notarize et)
          xcrun notarytool submit "$ZIP_PATH" --keychain-profile "rezvix-notary" --wait

      # -------------------- mac: upload artifacts to GitHub Release --------------------
      - name: Upload mac artifacts to GitHub Release
        if: runner.os == 'macOS'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            rezzy-webpanel/dist/*.dmg
            rezzy-webpanel/dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}